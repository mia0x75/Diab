name: "trigger"

on:
  workflow_dispatch:
  schedule:
    - cron: '*/30 * * * *'

jobs:
  check-repos:
    runs-on: ubuntu-latest
    steps:
      - name: checkout repository
        uses: actions/checkout@v4

      - name: set up environment
        run: |
          sudo apt-get update
          sudo apt-get install -y jq curl

      - name: check for new releases
        id: check-releases
        run: |
          repos=$(cat .github/workflows/repos.json  | jq -c '.[]')
          
          for repo in $repos; do
            owner=$(echo $repo | jq -r '.owner')
            name=$(echo $repo | jq -r '.repo')
            pattern=$(echo $repo | jq -r '.pattern')
            type=$(echo $repo | jq -r '.type')
            current_version=$(echo $repo | jq -r '.version')
                        
            case ${type} in 
              1) url="https://api.github.com/repos/${owner}/${name}/releases"
                key_name="tag_name"
                ;;
              2) url="https://api.github.com/repos/${owner}/${name}/tags"
                key_name="name"
                ;;
              3) url="https://api.github.com/repos/${owner}/${name}/commits?per_page=2"
                key_name="sha"
                ;;
              *)
                exit 1 # Command to come out of the program with status 1
                ;; 
            esac

            releases=$(wget -qO- --tries=3 $url | jq -r ".[].$key_name")
            latest_version=$(grep -vm1 '-' <<< "$releases")
            if [ "$pattern" != "" ]; then
              latest_version=$(echo "$latest_version" | sed "$pattern")
            fi

            if [ "${type}" = "3" ]; then
              latest_version=$(echo $latest_version | head -c 7)
            fi

            echo -e "url:             $url\nrepo:            $owner/$name\ntype:            $type\ncurrent version: $current_version\nlatest version:  $latest_version\n--------------------------------------------------------------------------------"

            if [ "$latest_version" != "$current_version" ]; then
              echo "owner=${owner}" >> $GITHUB_OUTPUT
              echo "repo=${name}" >> $GITHUB_OUTPUT
              echo "version=${latest_version}" >> $GITHUB_OUTPUT
              echo "current_version=${current_version}" >> $GITHUB_OUTPUT
              exit 0
            fi
          done

      - name: trigger build
        if: steps.check-releases.outputs.owner != ''
        uses: peter-evans/repository-dispatch@v3
        with:
          token: ${{ secrets.PAT }}
          event-type: "Auto Build ${{ steps.check-releases.outputs.repo }}"
          client-payload: >
            {
              "owner": "${{ steps.check-releases.outputs.owner }}",
              "repo": "${{ steps.check-releases.outputs.repo }}",
              "version": "${{ steps.check-releases.outputs.version }}",
              "current_version": "${{ steps.check-releases.outputs.current_version }}"
            }

  housekeep:
    needs: check-repos
    runs-on: ubuntu-latest
    steps:
      - name: delete old workflow runs
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ secrets.PAT }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: "trigger"
          retain_days: 0
          keep_minimum_runs: 0
          delete_run_by_conclusion_pattern: "cancelled, skipped, success"
